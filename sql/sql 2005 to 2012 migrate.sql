--STEP 1 COPY CODE FOR VIEWS
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET XACT_ABORT ON
GO
----CREATE TEMP TABLES
CREATE TABLE #CodeForViews(
	[ID]	INT,
	[Name] SYSNAME,
	[ColID]	SMALLINT,
	[Text]	NVARCHAR(MAX)
)

CREATE TABLE #CombinedCodeForViews(
	[ID]	INT,
	[Name] SYSNAME,
	[Text]	NVARCHAR(MAX)
)

CREATE TABLE #CombinedCodeForViewsNonOrdered(
	[OrderID] INT IDENTITY(1,1),
	[ID]	INT,
	[Text]	NVARCHAR(MAX)
)

CREATE TABLE #CombinedCodeForViewsOrdered(
	[OrderID] INT IDENTITY(1,1),
	[ID]	INT,
	[Text]	NVARCHAR(MAX)
)

CREATE TABLE #ViewsList(
	[ID] INT IDENTITY(1,1),
	[Name] SYSNAME
)

BEGIN TRANSACTION

	DECLARE 
		@TempViewCode NVARCHAR(MAX),
		@ViewsInDB INT,
		@Count INT,
		@ColID INT,
		@MaxColID INT,
		@ID INT,
		@ErrorMessage NVARCHAR(4000),
		@ErrorSeverity INT,
		@ErrorState INT
	
	BEGIN TRY
		----INSERT SPLITTED CODE INTO TEMP TABLE
		INSERT INTO #CodeForViews(
			[ID],
			[Name],
			[ColID],
			[Text]
		)
		SELECT 
			[id],
			[name],
			[colid],
			[text] 
		FROM sys.views 
		INNER JOIN syscomments ON sys.views.object_id = syscomments.id

		----INSERT THE LIST OF VIEWS WITHOUT DUBLICATES
		INSERT INTO #ViewsList(
			[Name]
		)
		SELECT DISTINCT
			[Name]
		FROM #CodeForViews

		----CONCATENATE THE CODE FOR VIEWS AND INSERT IT TO THE TEMP TABLE
		SELECT @ViewsInDB = MAX([ID]) FROM #ViewsList
		SET @Count = 1

		WHILE @ViewsInDB >= @Count
		BEGIN
			SET @TempViewCode = ''
			SET @ColID = 1
			
			SELECT 
				@MaxColID = MAX(#CodeForViews.[ColID]), 
				@ID = MAX(#CodeForViews.[ID]) 
			FROM #CodeForViews
			INNER JOIN #ViewsList ON #CodeForViews.[Name] = #ViewsList.[Name]
			WHERE #ViewsList.[ID] = @Count
			
			WHILE @MaxColID >= @ColID
			BEGIN
				SELECT @TempViewCode = @TempViewCode + [Text] 
				FROM #CodeForViews 
				WHERE [ColID] = @ColID
				AND [ID] = @ID
				
				SET @ColID = @ColID + 1
			END
			
			INSERT INTO #CombinedCodeForViews(
				[ID],
				[Name],
				[Text]
			)
			SELECT 
				#CodeForViews.[ID],
				#CodeForViews.[Name],
				@TempViewCode 
			FROM #CodeForViews
			WHERE [ColID] = 1
			AND [ID] = @ID
			
			SET @Count = @Count + 1
		END;

		----CREATE ORDERED LIST OF CODE FOR VIEWS
		WITH ViewDependenciesCTE([referencing_id], [Text], [Level]) AS (
		SELECT
			DEP.[referencing_id],
			CCFV1.[Text],
			0 AS [Level]
			FROM sys.sql_expression_dependencies as DEP 
			INNER JOIN #CombinedCodeForViews AS CCFV1 ON DEP.[referencing_id] = CCFV1.[ID]
			INNER JOIN #CombinedCodeForViews AS CCFV2 ON DEP.[referenced_id] = CCFV2.[ID]
			WHERE DEP.[referenced_id] != DEP.[referencing_id]
		UNION ALL
		SELECT
			DEP.[referencing_id],
			CCFV1.[Text],
			[Level] + 1
		FROM sys.sql_expression_dependencies as DEP 
			INNER JOIN #CombinedCodeForViews AS CCFV1 ON DEP.[referencing_id] = CCFV1.[ID] 
			INNER JOIN #CombinedCodeForViews AS CCFV2 ON DEP.[referenced_id] = CCFV2.[ID]
			INNER JOIN ViewDependenciesCTE AS CTE ON CTE.[referencing_id] = DEP.[referenced_id]
		)

		INSERT INTO #CombinedCodeForViewsOrdered(
			[ID],
			[Text]
				)
		SELECT
			[ID],
			[Text]
		FROM(
			SELECT 
				[referencing_id] AS [ID],
				[Text],
				MAX([Level]) AS [OrderID]
			FROM ViewDependenciesCTE
			GROUP BY [referencing_id],[Text]
		) ReferenceTable
		ORDER BY [OrderID]

		----CREATE THE LIST OF VIEWS WHICH CAN BE CREATED WITHOUT AN ORDER (ROOT VIEWS) 
		INSERT INTO #CombinedCodeForViewsNonOrdered(
			[ID],
			[Text]
		)
		SELECT 
			CCFV.[ID],
			CCFV.[Text]
		FROM #CombinedCodeForViews CCFV
		LEFT JOIN #CombinedCodeForViewsOrdered CCFVO ON CCFV.[ID] = CCFVO.[ID]
		WHERE CCFVO.[ID] IS NULL
	END TRY
	BEGIN CATCH
		SELECT 
			@ErrorMessage = ERROR_MESSAGE(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE();

		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
	END CATCH
	
	--STEP 2
	----DELETE VIEWS
	BEGIN TRY
		DECLARE 
			@name  VARCHAR(1000),
			@sqlstring NVARCHAR(4000),
			@nCountMax INTEGER,
			@nCount INTEGER,
			@nTopCount INTEGER

		WHILE (SELECT COUNT(TABLE_NAME) FROM INFORMATION_SCHEMA.VIEWS) > 0 AND @@ERROR = 0
			BEGIN
				SET @nCount = 1
				SET @nTopCount = 1
				SELECT @nCountMax = (SELECT COUNT(TABLE_NAME) FROM INFORMATION_SCHEMA.VIEWS)
				WHILE @nCount <= @nCountMax AND @@ERROR = 0
					BEGIN
						BEGIN TRY
							SELECT @name = (SELECT [name] FROM (SELECT QUOTENAME(TABLE_SCHEMA) + '.' + QUOTENAME(TABLE_NAME) AS [name], ROW_NUMBER() OVER (ORDER BY TABLE_NAME) AS RowNum FROM INFORMATION_SCHEMA.VIEWS) sub WHERE RowNum = @nTopCount)
							SELECT @sqlstring = 'DROP VIEW ' + @name
							EXEC (@sqlstring)
						END TRY						
						BEGIN CATCH
							IF ERROR_NUMBER() = 3729
								SET @nTopCount = @nTopCount + 1
							ELSE
								BEGIN
									SELECT
										@ErrorMessage = ERROR_MESSAGE(),
										@ErrorSeverity = ERROR_SEVERITY(),
										@ErrorState = ERROR_STATE();
									RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
								END
						END CATCH
						SET @nCount = @nCount + 1
					END
			END
	END TRY
	BEGIN CATCH		 
		SELECT
			@ErrorMessage = ERROR_MESSAGE(),
			@ErrorSeverity = ERROR_SEVERITY(),
			@ErrorState = ERROR_STATE();
		RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState)
	END CATCH
	
	DECLARE 
		@var AS VARCHAR(20),
		@version AS INT

	SET @var = CAST((SELECT SERVERPROPERTY('productversion')) AS VARCHAR(20))
	SET @var = left(@var,CHARINDEX('.',@var)-1)
	SET @version = CAST(@var AS INT)

	IF @version >= 10
		BEGIN
			--STEP 3 
			----DROP AGGREGATE AND ASSEMBLY
			IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FormDelimitedString]') AND type = N'AF')
			DROP AGGREGATE [dbo].[FormDelimitedString]

			IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FormDelimitedSubString]') AND type = N'AF')
			DROP AGGREGATE [dbo].[FormDelimitedSubString]

			IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[FormDelimitedSubSubString]') AND type = N'AF')
			DROP AGGREGATE [dbo].[FormDelimitedSubSubString]
			
			IF  EXISTS (SELECT * FROM sys.assemblies asms WHERE asms.name = N'SelectMedicalSQLProject')
			DROP ASSEMBLY [SelectMedicalSQLProject]

			--STEP 4
			----CREATE NEW AGGREGATE AND ASSEMBLY
			CREATE ASSEMBLY [SelectMedicalSQLProject]
			AUTHORIZATION [dbo]
			FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0104002AA48B510000000000000000E00002210B01080000160000000E000000000000CE35000000200000004000000000400000200000000200000400000000000000040000000000000000A000000004000000000000020040850000100000100000000010000010000000000000100000000000000000000000783500005300000000600000F008000000000000000000000000000000000000008000000C000000004000001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000D4150000002000000016000000040000000000000000000000000000200000602E73646174610000D40000000040000000020000001A0000000000000000000000000000400000C02E72737263000000F008000000600000000A0000001C0000000000000000000000000000400000402E72656C6F6300000C000000008000000002000000260000000000000000000000000000400000420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B035000000000000480000000200050020270000580E000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002602280300000A00002A00003A0002730400000A7D01000004002A00133003004F000000010000110020FD000000280500000A0A036F0600000A166A3305002B342B3100027B01000004036F0700000A13111211280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A005600027B01000004037B010000046F0C00000A26002A000013300500670000000200001100176A0B027B0100000472050000706F0900000A260007176AD60B0720102700006A31E01202027B0100000416027B010000046F0D00000A18DA6F0E00000A280F00000A001202FE16070000016F1000000A0D096F1100000A0A06731200000A13042B0011042A00520002036F1300000A731400000A7D01000004002A000000560003027B010000046F1500000A6F1600000A00002A00002602280300000A00002A00003A0002730400000A7D02000004002A001330030046000000030000110020FC000000280500000A0A0F01281A00000A2C05002B2C2B2900027B020000040F01280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A00005600027B02000004037B020000046F0C00000A26002A000013300500630000000400001100027B020000046F0D00000A16313F1201027B0200000416027B020000046F0D00000A18DA6F0E00000A280F00000A001201FE16070000016F1000000A0C086F1100000A0A06731200000A0D2B13007209000070281B00000A731C00000A0D2B00092A00520002036F1300000A731400000A7D02000004002A000000560003027B020000046F1500000A6F1600000A00002A00002602280300000A00002A00003A0002730400000A7D03000004002A001330030046000000050000110020FD000000280500000A0A0F01281A00000A2C05002B2C2B2900027B030000040F01280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A00005600027B03000004037B030000046F0C00000A26002A000013300500480000000600001100027B030000046F0D00000A1631251201027B0300000416027B030000046F0D00000A18DA6F0E00000A280F00000A00070A2B120012017209000070280F00000A00070A2B00062A520002036F1300000A731400000A7D03000004002A000000560003027B030000046F1500000A6F1600000A00002A00002602280300000A00002A00003A0002730400000A7D04000004002A001330030046000000070000110020FC000000280500000A0A0F01281A00000A2C05002B2C2B2900027B040000040F01280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A00005600027B04000004037B040000046F0C00000A26002A000013300500480000000800001100027B040000046F0D00000A1631251201027B0400000416027B040000046F0D00000A18DA6F0E00000A280F00000A00070A2B120012017209000070280F00000A00070A2B00062A520002036F1300000A731400000A7D04000004002A000000560003027B040000046F1500000A6F1600000A00002A00002602280300000A00002A00003A0002730400000A7D05000004002A001330030046000000090000110020FB000000280500000A0A0F01281A00000A2C05002B2C2B2900027B050000040F01280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A00005600027B05000004037B050000046F0C00000A26002A000013300500480000000A00001100027B050000046F0D00000A1631251201027B0500000416027B050000046F0D00000A18DA6F0E00000A280F00000A00070A2B120012017209000070280F00000A00070A2B00062A520002036F1300000A731400000A7D05000004002A000000560003027B050000046F1500000A6F1600000A00002A00002602280300000A00002A00003A0002730400000A7D06000004002A0013300300460000000B0000110020FD000000280500000A0A0F01281A00000A2C05002B2C2B2900027B060000040F01280800000A6F0900000A06280A00000A7201000070280B00000A6F0900000A2600002A00005600027B06000004037B060000046F0C00000A26002A000013300500890000000C00001100176A0B027B0600000472050000706F0900000A260007176AD60B0720102700006A31E0027B060000046F0D00000A1631401202027B0600000416027B060000046F0D00000A18DA6F0E00000A280F00000A001202FE16070000016F1000000A0D096F1100000A0A06731200000A13042B14007209000070281B00000A731C00000A13042B0011042A000000520002036F1300000A731400000A7D06000004002A000000560003027B060000046F1500000A6F1600000A00002A000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000B8060000237E0000240700005C04000023537472696E677300000000800B00000C000000235553008C0B00001000000023475549440000009C0B0000BC02000023426C6F620000000000000002000001571702020900000000FA253300160000010000001C00000007000000060000002A000000180000000600000029000000190000000C0000000C000000010000000300000000003E0401000000000006009F0098000E00CD00B2000600F000E4000E0025011001060059014F0106006D014F010E00820110010A008C0113000A00E701C0010600FC0198000E002102B2000E004202B200060049029800060072025F020E00A602B2000600B8025F024300CC0200000600FB02DB0206001B03DB0206005803390306006603390306007A0398000600A20390030600BD0390030600D80390030600F103900306000A04900306002704900300000000010000000000010001000120000029002D000500010001000120000045002D00050002000800012000004A002D00050003000F00012000005E002D000500040016000120000075002D00050005001D00012000008F002D000500060024000100FE0017000100FE0017000100FE0017000100FE0017000100FE0017000100FE0017005020000000000618DE00130001005C200000000006000B01130001006C200000000006002E011B000100C8200000000006003F0121000200E020000000000600450127000300542100000000660366012C0003006C210000000066037A01320004008421000000000618DE001300050090210000000006000B0113000500A0210000000006002E0138000500F4210000000006003F013E0006000C220000000006004501270007007C2200000000660366012C00070094220000000066037A0132000800AC22000000000618DE0013000900B8220000000006000B0113000900C8220000000006002E01380009001C230000000006003F0144000A00342300000000060045014A000B00882300000000660366012C000B00A0230000000066037A0132000C00B823000000000618DE0013000D00C4230000000006000B0113000D00D4230000000006002E0138000D0028240000000006003F014F000E00402400000000060045014A000F00942400000000660366012C000F00AC240000000066037A0132001000C424000000000618DE0013001100D0240000000006000B0113001100E0240000000006002E013800110034250000000006003F01550012004C2500000000060045014A001300A02500000000660366012C001300B8250000000066037A0132001400D025000000000618DE0013001500DC250000000006000B0113001500EC250000000006002E013800150040260000000006003F015B0016005826000000000600450127001700F02600000000660366012C00170008270000000066037A0132001800000001003901000001003901000001006B01000001008001000001003901000001003901000001006B01000001008001000001003901000001003901000001006B01000001008001000001003901000001003901000001006B01000001008001000001003901000001003901000001006B01000001008001000001003901000001003901000001006B01000001008001020009000300090004000900050009000600090007000900110066012C0011007A0132000900DE0013001900DE0013004100940161002100980166002100A3014A003900AF016A001900B9016E004900F30174005100030279001900B901A50019009801AB001900F301AF003900DE00B5000900F3016A0051000A02BA002100DE00BF00290016026A001900DE00B5001900F3016A0031007A01B5005900DE00D0006900DE0013007100DE00130039008F024E0139009A0256012100DE0038007900DE0013008100DE00F3019100DE00F9019900DE001300A100DE00B500A900DE00FE01B100DE00FE01B900DE00B500C100DE00B500C900DE00B500D100DE00B500D900DE00B500E100DE00B5002000CB0049012E0043015E022E00FB000C022E00030115022E003B01AA022E004B018D022E0013015E022E0033018D022E000B0134022E00F30003022E001B0164022E0023015E022E002B016A024300BB00D6006300BB00D6008300BB006D01A300BB006D01C300BB006D01E300BB006D010001CB0049012401EB00E001E001CB004901C002CB004901A003CB0049018004CB0049017F00C50052015C015201660152016601520166015201C50002000C00030002000E00050003001A00030003001C00050004002A00050004002800030005003600030005003800050006004400030006004600050007005200030007005400050004800000010000000D1339320000000000002D00000002000000000000000000000001000A00000000000800000000000000000000000A001300000000000200000000000000000000000100A600000000000000003C4D6F64756C653E006D73636F726C6962004D6963726F736F66742E56697375616C4261736963006664730053656C6563744D65646963616C53514C50726F6A656374006664733200466F726D44656C696D69746564537472696E6700466F726D44656C696D69746564537562537472696E6700466F726D44656C696D69746564537562537562537472696E670074657374636173650053797374656D004F626A6563740053797374656D2E44617461004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A65002E63746F720053797374656D2E5465787400537472696E674275696C6465720072657475726E537472696E6700496E69740053797374656D2E446174612E53716C54797065730053716C436861727300416363756D756C6174650076616C7565004D65726765005465726D696E6174650053797374656D2E494F0042696E617279526561646572005265616400720042696E61727957726974657200577269746500770053716C537472696E6700537472696E677300436872006765745F4C656E67746800546F53716C537472696E67006765745F56616C756500417070656E64004D6963726F736F66742E56697375616C42617369632E436F6D70696C6572536572766963657300436F6E76657273696F6E7300546F537472696E6700537472696E6700436F6E63617400546F4368617241727261790052656164537472696E670053716C55736572446566696E656441676772656761746541747472696275746500466F726D61740053657269616C697A61626C654174747269627574650053797374656D2E446961676E6F73746963730044656275676765724E6F6E55736572436F6465417474726962757465006765745F49734E756C6C006F705F496D706C696369740053716C46616365744174747269627574650044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E496E7465726F705365727669636573004775696441747472696275746500436F6D56697369626C6541747472696275746500434C53436F6D706C69616E744174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C7954726164656D61726B41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C795469746C654174747269627574650053656C6563744D65646963616C53514C50726F6A6563742E646C6C000000000320000003610000010000D05BF87E68598D45B26953EAA6F717B50008B77A5C561934E08908B03F5F7F11D50A3A032000010306120D052001011211052001011208042000121105200101121505200101121905200101111D05200101120C052001011210042000111D05200101121405200101121805200101121C04000103080320000A0320000E052001120D0E0400010E030500020E0E0E25071203111D111D111D111D111D111D111D111D111D111D111D111D111D111D111D111D111D052001120D1C032000080520020E0808042001010E0420001D03052001011D030A07051D030A111D0E12110520010111317201000200000005005402174973496E76617269616E74546F4475706C696361746573005402124973496E76617269616E74546F4E756C6C73015402124973496E76617269616E74546F4F726465720054020D49734E756C6C4966456D7074790154080B4D61784279746553697A65401F000004010000000320000203070103050001111D0E0907041D03111D0E1211060702111D111D7201000200000005005402174973496E76617269616E74546F4475706C696361746573005402124973496E76617269616E74546F4E756C6C73015402124973496E76617269616E74546F4F726465720054020D49734E756C6C4966456D7074790154080B4D61784279746553697A65FFFFFFFF12010001005408074D617853697A65FFFFFFFF052001011145042001010804200101020801000301000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773012901002430366262356261652D306336372D346664322D386363352D33313737653538373764326500000501000000000501000100002201001D436F7079726967687420C2A92054435320416D6572696361203230303600001C01001753656C6563744D65646963616C53514C50726F6A65637400001001000B54435320416D6572696361000000A03500000000000000000000BE350000002000000000000000000000000000000000000000000000B035000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002AA48B510000000002000000B80000001C4000001C1A0000525344533B096A77E2B0214B99EBB3048646343201000000433A5C5254436F64655C5265686162546F6F6C6B69745C52542053514C5C525420342E33372D6A6F655C536F757263655C53514C20434C522050726F6A656374735C436F7079206F662053454C4543544D45444943414C53514C50524F4A4543545C53656C6563744D65646963616C53514C50726F6A6563745C6F626A5C44656275675C53656C6563744D65646963616C53514C50726F6A6563742E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030003000000280000800E000000480000801000000060000080000000000000000000000000000002000200000078000080030000009000008000000000000000000000000000000100007F0000A80000800000000000000000000000000000010001000000C00000800000000000000000000000000000010000000000D80000000000000000000000000000000000010000000000E80000000000000000000000000000000000010000000000F8000000000000000000000000000000000001000000000008010000B8640000E80200000000000000000000A0670000280100000000000000000000C868000022000000000000000000000018610000A00300000000000000000000A00334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE000001000000010039320D130000010039320D133F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00400030000010053007400720069006E006700460069006C00650049006E0066006F000000DC020000010030003000300030003000340062003000000038000C00010043006F006D00700061006E0079004E0061006D00650000000000540043005300200041006D00650072006900630061000000580018000100460069006C0065004400650073006300720069007000740069006F006E0000000000530065006C006500630074004D00650064006900630061006C00530051004C00500072006F006A00650063007400000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0034003800370037002E00310032003800350037000000000058001C00010049006E007400650072006E0061006C004E0061006D0065000000530065006C006500630074004D00650064006900630061006C00530051004C00500072006F006A006500630074002E0064006C006C00000060001D0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A9002000540043005300200041006D0065007200690063006100200032003000300036000000000060001C0001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530065006C006500630074004D00650064006900630061006C00530051004C00500072006F006A006500630074002E0064006C006C000000500018000100500072006F0064007500630074004E0061006D00650000000000530065006C006500630074004D00650064006900630061006C00530051004C00500072006F006A00650063007400000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0034003800370037002E00310032003800350037000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0034003800370037002E003100320038003500370000000000280000002000000040000000010004000000000080020000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777777777777777777700444444444444444444444444444447004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF47004FFFFFFFFFFFFFFFFFFFFFFFFFFF4700488888888888888888888888888847004444444444444444444444444444470044C4C4C4C4C4C4C4C4C4ECECE49747004CCCCCCCCCCCCCCCCCCCCCCCCCCC40000444444444444444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC00000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000001800000018000000180000003C0000007FFFFFFFFFFFFFFFFFFFFFFFF2800000010000000200000000100040000000000C0000000000000000000000000000000000000000000000000008000008000000080800080000000800080008080000080808000C0C0C0000000FF0000FF000000FFFF00FF000000FF00FF00FFFF0000FFFFFF000000000000000000077777777777777744444444444444474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF8474FFFFFFFFFFFF84748888888888888474CCCCCCCCCCCCC47C4444444444444C000000000000000000000000000000000FFFF000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000FFFF0000FFFF00000000010002002020100001000400E8020000020010101000010004002801000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000D03500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
			WITH PERMISSION_SET = SAFE

			CREATE AGGREGATE [dbo].[FormDelimitedString]
			(@value [nvarchar](max))
			RETURNS[nvarchar](max)
			EXTERNAL NAME [SelectMedicalSQLProject].[SelectMedicalSQLProject.FormDelimitedString]

			CREATE AGGREGATE [dbo].[FormDelimitedSubString]
			(@value [nvarchar](max))
			RETURNS[nvarchar](max)
			EXTERNAL NAME [SelectMedicalSQLProject].[SelectMedicalSQLProject.FormDelimitedSubString]

			CREATE AGGREGATE [dbo].[FormDelimitedSubSubString]
			(@value [nvarchar](max))
			RETURNS[nvarchar](max)
			EXTERNAL NAME [SelectMedicalSQLProject].[SelectMedicalSQLProject.FormDelimitedSubSubString]
	END

	--STEP 5
	----CREATE NON ORDERED VIEWS
	SELECT @ViewsInDB = COUNT([ID]) FROM #CombinedCodeForViewsNonOrdered
	SET @Count = 1

	WHILE @ViewsInDB >= @Count
	BEGIN
		SET @TempViewCode = ''
		
		SELECT @TempViewCode = [Text] 
		FROM #CombinedCodeForViewsNonOrdered
		WHERE [OrderID] = @Count
		
		BEGIN TRY
			EXEC dbo.sp_executesql @TempViewCode
		END TRY
		BEGIN CATCH
			SELECT 
				@ErrorMessage = ERROR_MESSAGE(),
				@ErrorSeverity = ERROR_SEVERITY(),
				@ErrorState = ERROR_STATE();

			RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
			BREAK
		END CATCH
		
		SET @Count = @Count + 1
	END

	----CREATE ORDERED VIEWS
	SELECT @ViewsInDB = COUNT([ID]) FROM #CombinedCodeForViewsOrdered
	SET @Count = 1

	WHILE @ViewsInDB >= @Count
	BEGIN
		SET @TempViewCode = ''
		
		SELECT @TempViewCode = [Text] 
		FROM #CombinedCodeForViewsOrdered
		WHERE [OrderID] = @Count
		
		BEGIN TRY
			EXEC dbo.sp_executesql @TempViewCode
		END TRY
		BEGIN CATCH
			SELECT 
				@ErrorMessage = ERROR_MESSAGE(),
				@ErrorSeverity = ERROR_SEVERITY(),
				@ErrorState = ERROR_STATE();

			RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
			BREAK
		END CATCH
		
		SET @Count = @Count + 1
	END
	
IF @@ERROR = 0
	COMMIT
ELSE
	ROLLBACK

DROP TABLE #CodeForViews
DROP TABLE #CombinedCodeForViews
DROP TABLE #CombinedCodeForViewsNonOrdered
DROP TABLE #CombinedCodeForViewsOrdered
DROP TABLE #ViewsList

GO

SET XACT_ABORT OFF